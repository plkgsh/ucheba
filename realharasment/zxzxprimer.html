<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã—á–∏—Å–ª–µ–Ω–∏–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∞–Ω—Ç–∞ –º–∞—Ç—Ä–∏—Ü—ã</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.05"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .header p {
            opacity: 0.95;
            font-size: 1.2em;
            font-weight: 300;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 50px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .setting-group {
            background: linear-gradient(145deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .setting-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.12);
        }

        .setting-group h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.2em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-group h3::before {
            content: '‚öôÔ∏è';
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 0.95em;
        }

        input, select, button {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .checkbox-group:hover {
            background: #e9ecef;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
            transform: scale(1.2);
        }

        .matrix-input {
            margin: 40px 0;
            background: linear-gradient(145deg, #f8f9fa 0%, #ffffff 100%);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }

        .matrix-input h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.4em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .matrix-input h3::before {
            content: 'üî¢';
            font-size: 1.2em;
        }

        .matrix-table {
            display: inline-block;
            border: 3px solid #e1e8ed;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            background: white;
        }

        .matrix-table input {
            width: 90px;
            text-align: center;
            border: none;
            border-right: 2px solid #e1e8ed;
            border-bottom: 2px solid #e1e8ed;
            border-radius: 0;
            padding: 15px 10px;
            font-weight: 500;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .matrix-table input:focus {
            background: #f8f9ff;
            transform: scale(1.05);
            z-index: 10;
            position: relative;
        }

        .matrix-table input:last-child {
            border-right: none;
        }

        .matrix-table tr:last-child input {
            border-bottom: none;
        }

        .buttons {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin: 40px 0;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 140px;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(-1px);
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .solution {
            margin-top: 40px;
            padding: 30px;
            background: linear-gradient(145deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 15px;
            border-left: 5px solid #27ae60;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }

        .solution h3 {
            color: #27ae60;
            margin-bottom: 25px;
            font-size: 1.5em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .solution h3::before {
            content: 'üßÆ';
            font-size: 1.3em;
        }

        .step {
            margin: 25px 0;
            padding: 25px;
            background: white;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }

        .step:hover {
            transform: translateX(5px);
        }

        .step h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step h5 {
            color: #2c3e50;
            margin: 15px 0 10px 0;
            font-size: 1.1em;
            font-weight: 600;
        }

        .formula-box {
            background: linear-gradient(145deg, #f8f9ff 0%, #ffffff 100%);
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .formula-box .math {
            font-size: 1.2em;
            color: #2c3e50;
            font-weight: 500;
        }

        .step-content {
            font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
            background: linear-gradient(145deg, #f1f3f4 0%, #ffffff 100%);
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            margin: 15px 0;
            border: 1px solid #e1e8ed;
            font-size: 14px;
            line-height: 1.5;
        }

        .trace-tree {
            margin-left: 25px;
            border-left: 2px solid #e1e8ed;
            padding-left: 20px;
        }

        .trace-node {
            margin: 15px 0;
            padding: 20px;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .trace-node:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .trace-node.collapsed {
            opacity: 0.7;
        }

        .trace-toggle {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .trace-toggle:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .answer {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(39, 174, 96, 0.3);
            position: relative;
            overflow: hidden;
        }

        .answer::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .step {
            animation: fadeInUp 0.6s ease-out;
        }

        .trace-node {
            animation: fadeInUp 0.4s ease-out;
        }

        .formula-box {
            animation: fadeInUp 0.5s ease-out;
        }

        .answer {
            animation: fadeInUp 0.8s ease-out;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-animation {
            animation: pulse 0.6s ease-in-out;
        }

        .answer h3 {
            margin-bottom: 15px;
            font-size: 1.6em;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .answer .exact {
            font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
            font-size: 1.4em;
            margin: 15px 0;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .answer .approximate {
            font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
            font-size: 1.2em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .warning {
            background: linear-gradient(145deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            color: #8b4513;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.2);
        }

        .error {
            background: linear-gradient(145deg, #f8d7da 0%, #f5c6cb 100%);
            border: 2px solid #e74c3c;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.2);
        }

        .info {
            background: linear-gradient(145deg, #d1ecf1 0%, #bee5eb 100%);
            border: 2px solid #17a2b8;
            color: #0c5460;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.2);
        }

        .math-display {
            font-size: 1.3em;
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(145deg, #f8f9ff 0%, #ffffff 100%);
            border-radius: 10px;
            border: 2px solid #e1e8ed;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .term-box {
            display: inline-block;
            margin: 10px;
            padding: 15px 20px;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .term-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .term-box.positive {
            border-color: #27ae60;
            background: linear-gradient(145deg, #d5f4e6 0%, #ffffff 100%);
        }

        .term-box.negative {
            border-color: #e74c3c;
            background: linear-gradient(145deg, #fadbd8 0%, #ffffff 100%);
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .matrix-table input {
                width: 70px;
            }
            
            .content {
                padding: 30px 20px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–í—ã—á–∏—Å–ª–µ–Ω–∏–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∞–Ω—Ç–∞ –º–∞—Ç—Ä–∏—Ü—ã</h1>
            <p>–ü–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å —Ç–æ—á–Ω—ã–º–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è–º–∏</p>
        </div>
        
        <div class="content">
            <div class="settings-grid">
                <div class="setting-group">
                    <h3>–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –º–∞—Ç—Ä–∏—Ü—ã</h3>
                    <div class="form-group">
                        <label for="matrixSize">–†–∞–∑–º–µ—Ä n (2-8):</label>
                        <input type="number" id="matrixSize" min="2" max="8" value="3">
                    </div>
                </div>
                
                <div class="setting-group">
                    <h3>–ú–µ—Ç–æ–¥ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è</h3>
                    <div class="form-group">
                        <label for="method">–ú–µ—Ç–æ–¥:</label>
                        <select id="method">
                            <option value="sarrus">–°–∞—Ä—Ä—é—Å (—Ç–æ–ª—å–∫–æ 3√ó3)</option>
                            <option value="laplace">–†–∞–∑–ª–æ–∂–µ–Ω–∏–µ –ø–æ —Å—Ç—Ä–æ–∫–µ/—Å—Ç–æ–ª–±—Ü—É (Laplace)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="autoSelect">
                            <label for="autoSelect">–ê–≤—Ç–æ–≤—ã–±–æ—Ä —Å—Ç—Ä–æ–∫–∏/—Å—Ç–æ–ª–±—Ü–∞ —Å –Ω—É–ª—è–º–∏</label>
                        </div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã Laplace</h3>
                    <div class="form-group">
                        <label for="laplaceDirection">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</label>
                        <select id="laplaceDirection">
                            <option value="row">–ü–æ —Å—Ç—Ä–æ–∫–µ</option>
                            <option value="col">–ü–æ —Å—Ç–æ–ª–±—Ü—É</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="laplaceIndex">–ò–Ω–¥–µ–∫—Å (1-based):</label>
                        <input type="number" id="laplaceIndex" min="1" value="1">
                    </div>
                </div>
                
                <div class="setting-group">
                    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã–≤–æ–¥–∞</h3>
                    <div class="form-group">
                        <label for="precision">–¢–æ—á–Ω–æ—Å—Ç—å –¥–µ—Å—è—Ç–∏—á–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞:</label>
                        <input type="number" id="precision" min="0" max="12" value="6">
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="showSteps" checked>
                            <label for="showSteps">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —à–∞–≥–∏</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="matrix-input">
                <h3>–í–≤–æ–¥ –º–∞—Ç—Ä–∏—Ü—ã</h3>
                <div id="matrixContainer"></div>
                <div class="info">
                    <strong>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å—Ç–∞–≤–∫–∏:</strong> –°—Ç—Ä–æ–∫–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏ —Å—Ç—Ä–æ–∫–∏, —Å—Ç–æ–ª–±—Ü—ã ‚Äî –ø—Ä–æ–±–µ–ª–æ–º, —Ç–∞–±–æ–º, –∑–∞–ø—è—Ç–æ–π –∏–ª–∏ —Ç–æ—á–∫–æ–π —Å –∑–∞–ø—è—Ç–æ–π.
                </div>
            </div>
            
            <div class="buttons">
                <button onclick="generateRandomMatrix()">–°–ª—É—á–∞–π–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞</button>
                <button onclick="clearMatrix()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                <button onclick="loadExamples()">–ü—Ä–∏–º–µ—Ä—ã</button>
                <button onclick="calculateDeterminant()">–ü–æ—Å—á–∏—Ç–∞—Ç—å</button>
                <button onclick="copySolution()" id="copyBtn" disabled>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ</button>
            </div>
            
            <div id="solution" class="solution" style="display: none;">
                <h3>–†–µ—à–µ–Ω–∏–µ</h3>
                <div id="solutionContent"></div>
            </div>
        </div>
    </div>

    <script>
        // –ö–ª–∞—Å—Å —Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —á–∏—Å–µ–ª
        class Rational {
            constructor(num, den = 1n) {
                if (typeof num === 'string') {
                    const parsed = this.parseNumber(num);
                    this.num = parsed.num;
                    this.den = parsed.den;
                } else if (typeof num === 'number') {
                    const parsed = this.parseNumber(num.toString());
                    this.num = parsed.num;
                    this.den = parsed.den;
                } else {
                    this.num = BigInt(num);
                    this.den = BigInt(den);
                }
                this.normalize();
            }

            parseNumber(str) {
                str = str.trim();
                
                // –ù–∞—É—á–Ω–∞—è –∑–∞–ø–∏—Å—å
                if (str.includes('e') || str.includes('E')) {
                    const [mantissa, exponent] = str.toLowerCase().split('e');
                    const exp = parseInt(exponent);
                    const mantissaNum = new Rational(mantissa);
                    const power = new Rational(1, 10n ** BigInt(Math.abs(exp)));
                    return exp >= 0 ? mantissaNum.mul(power) : mantissaNum.div(power);
                }
                
                // –î–µ—Å—è—Ç–∏—á–Ω–∞—è –¥—Ä–æ–±—å
                if (str.includes('.')) {
                    const [intPart, fracPart] = str.split('.');
                    const denominator = 10n ** BigInt(fracPart.length);
                    const numerator = BigInt(intPart || '0') * denominator + BigInt(fracPart);
                    return { num: numerator, den: denominator };
                }
                
                // –¶–µ–ª–æ–µ —á–∏—Å–ª–æ
                return { num: BigInt(str), den: 1n };
            }

            gcd(a, b) {
                a = a < 0n ? -a : a;
                b = b < 0n ? -b : b;
                while (b !== 0n) {
                    [a, b] = [b, a % b];
                }
                return a;
            }

            normalize() {
                if (this.den === 0n) throw new Error('Division by zero');
                
                const g = this.gcd(this.num, this.den);
                this.num /= g;
                this.den /= g;
                
                // –ó–Ω–∞–∫ –≤ —á–∏—Å–ª–∏—Ç–µ–ª–µ
                if (this.den < 0n) {
                    this.num = -this.num;
                    this.den = -this.den;
                }
            }

            add(other) {
                const num = this.num * other.den + other.num * this.den;
                const den = this.den * other.den;
                return new Rational(num, den);
            }

            sub(other) {
                const num = this.num * other.den - other.num * this.den;
                const den = this.den * other.den;
                return new Rational(num, den);
            }

            mul(other) {
                const num = this.num * other.num;
                const den = this.den * other.den;
                return new Rational(num, den);
            }

            div(other) {
                if (other.isZero()) throw new Error('Division by zero');
                const num = this.num * other.den;
                const den = this.den * other.num;
                return new Rational(num, den);
            }

            neg() {
                return new Rational(-this.num, this.den);
            }

            isZero() {
                return this.num === 0n;
            }

            toString() {
                if (this.den === 1n) {
                    return this.num.toString();
                }
                return `${this.num}/${this.den}`;
            }

            toDecimal(precision = 6) {
                const sign = this.num < 0n ? -1 : 1;
                const absNum = this.num < 0n ? -this.num : this.num;
                
                let result = '';
                let quotient = absNum / this.den;
                let remainder = absNum % this.den;
                
                if (sign < 0) result += '-';
                result += quotient.toString();
                
                if (remainder !== 0n && precision > 0) {
                    result += '.';
                    for (let i = 0; i < precision; i++) {
                        remainder *= 10n;
                        result += (remainder / this.den).toString();
                        remainder %= this.den;
                        if (remainder === 0n) break;
                    }
                }
                
                return result;
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let matrix = [];
        let solutionText = '';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            createMatrixInput();
            updateUI();
        });

        function setupEventListeners() {
            document.getElementById('matrixSize').addEventListener('input', function() {
                createMatrixInput();
                updateUI();
            });
            
            document.getElementById('method').addEventListener('change', updateUI);
            document.getElementById('autoSelect').addEventListener('change', updateUI);
            document.getElementById('showSteps').addEventListener('change', updateUI);
        }

        function createMatrixInput() {
            const size = parseInt(document.getElementById('matrixSize').value);
            const container = document.getElementById('matrixContainer');
            
            let html = '<table class="matrix-table">';
            for (let i = 0; i < size; i++) {
                html += '<tr>';
                for (let j = 0; j < size; j++) {
                    html += `<td><input type="text" id="cell_${i}_${j}" value="0" placeholder="0"></td>`;
                }
                html += '</tr>';
            }
            html += '</table>';
            
            container.innerHTML = html;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
            const inputs = container.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('paste', handlePaste);
            });
        }

        function handlePaste(e) {
            e.preventDefault();
            const pastedData = (e.clipboardData || window.clipboardData).getData('text');
            const rows = pastedData.trim().split('\n');
            const size = parseInt(document.getElementById('matrixSize').value);
            
            const matrix = [];
            for (let i = 0; i < Math.min(rows.length, size); i++) {
                const row = rows[i].trim().split(/[\s,;]+/);
                matrix[i] = [];
                for (let j = 0; j < Math.min(row.length, size); j++) {
                    matrix[i][j] = row[j] || '0';
                }
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Ç—Ä–∏—Ü—É
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const input = document.getElementById(`cell_${i}_${j}`);
                    if (matrix[i] && matrix[i][j] !== undefined) {
                        input.value = matrix[i][j];
                    }
                }
            }
        }

        function updateUI() {
            const size = parseInt(document.getElementById('matrixSize').value);
            const method = document.getElementById('method').value;
            const autoSelect = document.getElementById('autoSelect').checked;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–µ—Ç–æ–¥–∞ –°–∞—Ä—Ä—é—Å–∞
            const sarrusOption = document.getElementById('method').options[0];
            if (size === 3) {
                sarrusOption.disabled = false;
            } else {
                sarrusOption.disabled = true;
                if (method === 'sarrus') {
                    document.getElementById('method').value = 'laplace';
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Laplace
            const laplaceParams = document.querySelectorAll('#laplaceDirection, #laplaceIndex');
            laplaceParams.forEach(param => {
                param.disabled = method === 'sarrus' || autoSelect;
            });
            
            document.getElementById('laplaceIndex').max = size;
            if (parseInt(document.getElementById('laplaceIndex').value) > size) {
                document.getElementById('laplaceIndex').value = size;
            }
            
            // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            showWarnings(size);
        }

        function showWarnings(size) {
            let warnings = [];
            
            if (size > 6) {
                warnings.push('‚ö†Ô∏è –ë–æ–ª—å—à–∏–µ –º–∞—Ç—Ä–∏—Ü—ã –º–æ–≥—É—Ç –¥–∞–≤–∞—Ç—å –º–Ω–æ–≥–æ —à–∞–≥–æ–≤ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è');
            }
            
            if (size > 8) {
                warnings.push('üö® –†–∞–∑–º–µ—Ä –±–æ–ª—å—à–µ 8 –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –≤–∑—Ä—ã–≤–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ O(n!)');
            }
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            const oldWarnings = document.querySelectorAll('.warning');
            oldWarnings.forEach(w => w.remove());
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
            warnings.forEach(text => {
                const warning = document.createElement('div');
                warning.className = 'warning';
                warning.textContent = text;
                document.querySelector('.matrix-input').appendChild(warning);
            });
        }

        function getMatrix() {
            const size = parseInt(document.getElementById('matrixSize').value);
            const matrix = [];
            
            for (let i = 0; i < size; i++) {
                matrix[i] = [];
                for (let j = 0; j < size; j++) {
                    const value = document.getElementById(`cell_${i}_${j}`).value.trim();
                    if (value === '') {
                        matrix[i][j] = new Rational(0);
                    } else {
                        try {
                            matrix[i][j] = new Rational(value);
                        } catch (e) {
                            throw new Error(`–ù–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–æ–∑–∏—Ü–∏–∏ (${i+1}, ${j+1}): ${value}`);
                        }
                    }
                }
            }
            
            return matrix;
        }

        function generateRandomMatrix() {
            const size = parseInt(document.getElementById('matrixSize').value);
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const value = (Math.random() - 0.5) * 10;
                    document.getElementById(`cell_${i}_${j}`).value = Math.round(value * 100) / 100;
                }
            }
        }

        function clearMatrix() {
            const inputs = document.querySelectorAll('#matrixContainer input');
            inputs.forEach(input => input.value = '0');
        }

        function loadExamples() {
            const size = parseInt(document.getElementById('matrixSize').value);
            
            if (size === 3) {
                // –ü—Ä–∏–º–µ—Ä –¥–ª—è –°–∞—Ä—Ä—é—Å–∞
                const example = [
                    ['1', '2', '3'],
                    ['0', '1', '4'],
                    ['5', '6', '0']
                ];
                fillMatrix(example);
                document.getElementById('method').value = 'sarrus';
            } else if (size === 4) {
                // –ü—Ä–∏–º–µ—Ä –¥–ª—è Laplace —Å –Ω—É–ª—è–º–∏
                const example = [
                    ['1', '0', '2', '0'],
                    ['0', '3', '0', '0'],
                    ['4', '0', '5', '0'],
                    ['0', '0', '0', '6']
                ];
                fillMatrix(example);
                document.getElementById('method').value = 'laplace';
                document.getElementById('laplaceDirection').value = 'row';
                document.getElementById('laplaceIndex').value = '1';
                document.getElementById('autoSelect').checked = true;
            } else if (size === 2) {
                // –ü—Ä–∏–º–µ—Ä —Å –¥–µ—Å—è—Ç–∏—á–Ω—ã–º–∏
                const example = [
                    ['0.5', '0'],
                    ['0', '0.2']
                ];
                fillMatrix(example);
                document.getElementById('method').value = 'laplace';
            }
            
            updateUI();
        }

        function fillMatrix(values) {
            const size = values.length;
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    document.getElementById(`cell_${i}_${j}`).value = values[i][j];
                }
            }
        }

        function calculateDeterminant() {
            const calculateBtn = document.querySelector('button[onclick="calculateDeterminant()"]');
            const originalText = calculateBtn.textContent;
            
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                calculateBtn.innerHTML = '<span class="loading"></span> –í—ã—á–∏—Å–ª—è–µ–º...';
                calculateBtn.disabled = true;
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
                setTimeout(() => {
                    try {
                        const matrix = getMatrix();
                        const size = matrix.length;
                        const method = document.getElementById('method').value;
                        
                        if (size > 8) {
                            throw new Error('–†–∞–∑–º–µ—Ä –º–∞—Ç—Ä–∏—Ü—ã –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ 8');
                        }
                        
                        let result;
                        let trace;
                        
                        if (method === 'sarrus' && size === 3) {
                            [result, trace] = sarrus3x3(matrix);
                        } else {
                            const direction = document.getElementById('laplaceDirection').value;
                            let index = parseInt(document.getElementById('laplaceIndex').value) - 1;
                            const autoSelect = document.getElementById('autoSelect').checked;
                            
                            if (autoSelect) {
                                index = findBestRowOrColumn(matrix, direction);
                            }
                            
                            [result, trace] = laplaceDet(matrix, direction, index, true);
                        }
                        
                        displaySolution(result, trace);
                        
                        // –ê–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞
                        calculateBtn.innerHTML = '‚úÖ –ì–æ—Ç–æ–≤–æ!';
                        calculateBtn.classList.add('success-animation');
                        
                        setTimeout(() => {
                            calculateBtn.textContent = originalText;
                            calculateBtn.classList.remove('success-animation');
                        }, 2000);
                        
                    } catch (error) {
                        showError(error.message);
                        calculateBtn.textContent = originalText;
                    } finally {
                        calculateBtn.disabled = false;
                    }
                }, 500);
                
            } catch (error) {
                showError(error.message);
                calculateBtn.textContent = originalText;
                calculateBtn.disabled = false;
            }
        }

        function sarrus3x3(matrix) {
            const trace = {
                type: 'sarrus',
                formula: 'det(A) = a‚ÇÅ‚ÇÅ¬∑a‚ÇÇ‚ÇÇ¬∑a‚ÇÉ‚ÇÉ + a‚ÇÅ‚ÇÇ¬∑a‚ÇÇ‚ÇÉ¬∑a‚ÇÉ‚ÇÅ + a‚ÇÅ‚ÇÉ¬∑a‚ÇÇ‚ÇÅ¬∑a‚ÇÉ‚ÇÇ - (a‚ÇÅ‚ÇÉ¬∑a‚ÇÇ‚ÇÇ¬∑a‚ÇÉ‚ÇÅ + a‚ÇÅ‚ÇÅ¬∑a‚ÇÇ‚ÇÉ¬∑a‚ÇÉ‚ÇÇ + a‚ÇÅ‚ÇÇ¬∑a‚ÇÇ‚ÇÅ¬∑a‚ÇÉ‚ÇÉ)',
                positiveTerms: [],
                negativeTerms: [],
                sumPositive: null,
                sumNegative: null,
                result: null
            };
            
            // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–∞–≥–∞–µ–º—ã–µ
            const pos1 = matrix[0][0].mul(matrix[1][1]).mul(matrix[2][2]);
            const pos2 = matrix[0][1].mul(matrix[1][2]).mul(matrix[2][0]);
            const pos3 = matrix[0][2].mul(matrix[1][0]).mul(matrix[2][1]);
            
            trace.positiveTerms = [
                { formula: 'a‚ÇÅ‚ÇÅ¬∑a‚ÇÇ‚ÇÇ¬∑a‚ÇÉ‚ÇÉ', values: `${matrix[0][0]}¬∑${matrix[1][1]}¬∑${matrix[2][2]}`, result: pos1 },
                { formula: 'a‚ÇÅ‚ÇÇ¬∑a‚ÇÇ‚ÇÉ¬∑a‚ÇÉ‚ÇÅ', values: `${matrix[0][1]}¬∑${matrix[1][2]}¬∑${matrix[2][0]}`, result: pos2 },
                { formula: 'a‚ÇÅ‚ÇÉ¬∑a‚ÇÇ‚ÇÅ¬∑a‚ÇÉ‚ÇÇ', values: `${matrix[0][2]}¬∑${matrix[1][0]}¬∑${matrix[2][1]}`, result: pos3 }
            ];
            
            // –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Å–ª–∞–≥–∞–µ–º—ã–µ
            const neg1 = matrix[0][2].mul(matrix[1][1]).mul(matrix[2][0]);
            const neg2 = matrix[0][0].mul(matrix[1][2]).mul(matrix[2][1]);
            const neg3 = matrix[0][1].mul(matrix[1][0]).mul(matrix[2][2]);
            
            trace.negativeTerms = [
                { formula: 'a‚ÇÅ‚ÇÉ¬∑a‚ÇÇ‚ÇÇ¬∑a‚ÇÉ‚ÇÅ', values: `${matrix[0][2]}¬∑${matrix[1][1]}¬∑${matrix[2][0]}`, result: neg1 },
                { formula: 'a‚ÇÅ‚ÇÅ¬∑a‚ÇÇ‚ÇÉ¬∑a‚ÇÉ‚ÇÇ', values: `${matrix[0][0]}¬∑${matrix[1][2]}¬∑${matrix[2][1]}`, result: neg2 },
                { formula: 'a‚ÇÅ‚ÇÇ¬∑a‚ÇÇ‚ÇÅ¬∑a‚ÇÉ‚ÇÉ', values: `${matrix[0][1]}¬∑${matrix[1][0]}¬∑${matrix[2][2]}`, result: neg3 }
            ];
            
            trace.sumPositive = pos1.add(pos2).add(pos3);
            trace.sumNegative = neg1.add(neg2).add(neg3);
            trace.result = trace.sumPositive.sub(trace.sumNegative);
            
            return [trace.result, trace];
        }

        function laplaceDet(matrix, direction, index, traceEnabled = true, depth = 0) {
            const size = matrix.length;
            
            if (size === 2) {
                return det2x2(matrix, traceEnabled, depth);
            }
            
            if (size === 3) {
                return sarrus3x3(matrix);
            }
            
            const trace = {
                type: 'laplace',
                direction,
                index,
                size,
                terms: [],
                result: new Rational(0)
            };
            
            let result = new Rational(0);
            
            for (let k = 0; k < size; k++) {
                const i = direction === 'row' ? index : k;
                const j = direction === 'col' ? index : k;
                const element = matrix[i][j];
                
                if (!element.isZero()) {
                    const minor = getMinor(matrix, i, j);
                    const [minorDet, minorTrace] = laplaceDet(minor, 'row', 0, traceEnabled, depth + 1);
                    const cofactor = element.mul(minorDet);
                    const sign = (i + j) % 2 === 0 ? 1 : -1;
                    const termValue = new Rational(sign).mul(cofactor);
                    
                    result = result.add(termValue);
                    
                    if (traceEnabled) {
                        trace.terms.push({
                            i: i + 1,
                            j: j + 1,
                            element,
                            minor,
                            minorDet,
                            cofactor,
                            sign,
                            termValue,
                            subTrace: minorTrace
                        });
                    }
                }
            }
            
            trace.result = result;
            return [result, trace];
        }

        function det2x2(matrix, traceEnabled = true, depth = 0) {
            const trace = {
                type: '2x2',
                formula: 'ad - bc',
                a: matrix[0][0],
                b: matrix[0][1],
                c: matrix[1][0],
                d: matrix[1][1],
                ad: matrix[0][0].mul(matrix[1][1]),
                bc: matrix[0][1].mul(matrix[1][0]),
                result: null
            };
            
            trace.result = trace.ad.sub(trace.bc);
            return [trace.result, trace];
        }

        function getMinor(matrix, row, col) {
            const size = matrix.length;
            const minor = [];
            let minorRow = 0;
            
            for (let i = 0; i < size; i++) {
                if (i !== row) {
                    minor[minorRow] = [];
                    let minorCol = 0;
                    for (let j = 0; j < size; j++) {
                        if (j !== col) {
                            minor[minorRow][minorCol] = matrix[i][j];
                            minorCol++;
                        }
                    }
                    minorRow++;
                }
            }
            
            return minor;
        }

        function findBestRowOrColumn(matrix, direction) {
            const size = matrix.length;
            let bestIndex = 0;
            let maxZeros = 0;
            
            for (let i = 0; i < size; i++) {
                let zeros = 0;
                for (let j = 0; j < size; j++) {
                    const element = direction === 'row' ? matrix[i][j] : matrix[j][i];
                    if (element.isZero()) zeros++;
                }
                if (zeros > maxZeros) {
                    maxZeros = zeros;
                    bestIndex = i;
                }
            }
            
            return bestIndex;
        }

        function renderMatrix(matrix) {
            const size = matrix.length;
            let matrixStr = '\\begin{pmatrix}\n';
            
            for (let i = 0; i < size; i++) {
                matrixStr += '  ';
                for (let j = 0; j < size; j++) {
                    matrixStr += matrix[i][j].toString();
                    if (j < size - 1) matrixStr += ' & ';
                }
                if (i < size - 1) matrixStr += ' \\\\';
                matrixStr += '\n';
            }
            matrixStr += '\\end{pmatrix}';
            
            return `
                <div class="step">
                    <h4>üìã –ò—Å—Ö–æ–¥–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞</h4>
                    <div class="formula-box">
                        <div class="math">$$A = ${matrixStr}$$</div>
                    </div>
                </div>
            `;
        }

        function renderMinorMatrix(minor) {
            if (!minor || minor.length === 0) return '\\emptyset';
            
            const size = minor.length;
            let matrixStr = '\\begin{pmatrix}\n';
            
            for (let i = 0; i < size; i++) {
                matrixStr += '  ';
                for (let j = 0; j < size; j++) {
                    matrixStr += minor[i][j].toString();
                    if (j < size - 1) matrixStr += ' & ';
                }
                if (i < size - 1) matrixStr += ' \\\\';
                matrixStr += '\n';
            }
            matrixStr += '\\end{pmatrix}';
            
            return matrixStr;
        }

        function displaySolution(result, trace) {
            const solutionDiv = document.getElementById('solution');
            const contentDiv = document.getElementById('solutionContent');
            const showSteps = document.getElementById('showSteps').checked;
            const precision = parseInt(document.getElementById('precision').value);
            
            let html = '';
            solutionText = '';
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –º–∞—Ç—Ä–∏—Ü—É
            try {
                const matrix = getMatrix();
                html += renderMatrix(matrix);
            } catch (e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –º–∞—Ç—Ä–∏—Ü—ã
            }
            
            if (showSteps) {
                html += renderTrace(trace, 0);
            }
            
            // –û—Ç–≤–µ—Ç
            html += `
                <div class="answer">
                    <h3>üéØ –û—Ç–≤–µ—Ç</h3>
                    <div class="math-display">
                        <div class="math">
                            $$\\det(A) = ${result.toString()}$$
                        </div>
                    </div>
                    <div class="exact">–¢–æ—á–Ω–æ: ${result.toString()}</div>
                    <div class="approximate">–ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ: ${result.toDecimal(precision)}</div>
                </div>
            `;
            
            contentDiv.innerHTML = html;
            solutionDiv.style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            solutionText = `–î–µ—Ç–µ—Ä–º–∏–Ω–∞–Ω—Ç –º–∞—Ç—Ä–∏—Ü—ã:\n\n`;
            if (showSteps) {
                solutionText += renderTraceText(trace, 0);
            }
            solutionText += `\n–û—Ç–≤–µ—Ç (—Ç–æ—á–Ω–æ): ${result.toString()}\n`;
            solutionText += `–û—Ç–≤–µ—Ç (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ): ${result.toDecimal(precision)}`;
            
            document.getElementById('copyBtn').disabled = false;
            
            // –†–µ–Ω–¥–µ—Ä–∏–º MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([contentDiv]);
            }
        }

        function renderTrace(trace, depth) {
            let html = '';
            const indent = '  '.repeat(depth);
            
            if (trace.type === 'sarrus') {
                html += `
                    <div class="step">
                        <h4>üî∫ –ú–µ—Ç–æ–¥ –°–∞—Ä—Ä—é—Å–∞ (3√ó3)</h4>
                        <div class="formula-box">
                            <div class="math">$$\\det(A) = a_{11}a_{22}a_{33} + a_{12}a_{23}a_{31} + a_{13}a_{21}a_{32} - (a_{13}a_{22}a_{31} + a_{11}a_{23}a_{32} + a_{12}a_{21}a_{33})$$</div>
                        </div>
                        
                        <h5>‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–∞–≥–∞–µ–º—ã–µ:</h5>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;">
                            ${trace.positiveTerms.map((term, i) => `
                                <div class="term-box positive">
                                    <div style="font-weight: 600; margin-bottom: 8px;">${i + 1}. ${term.formula}</div>
                                    <div style="font-family: monospace; font-size: 0.9em; color: #666;">
                                        ${term.values} = <strong>${term.result}</strong>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <h5>‚ùå –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Å–ª–∞–≥–∞–µ–º—ã–µ:</h5>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;">
                            ${trace.negativeTerms.map((term, i) => `
                                <div class="term-box negative">
                                    <div style="font-weight: 600; margin-bottom: 8px;">${i + 1}. ${term.formula}</div>
                                    <div style="font-family: monospace; font-size: 0.9em; color: #666;">
                                        ${term.values} = <strong>${term.result}</strong>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="formula-box">
                            <div class="math">
                                $$S_+ = ${trace.sumPositive}$$<br>
                                $$S_- = ${trace.sumNegative}$$<br>
                                $$\\det = S_+ - S_- = ${trace.sumPositive} - ${trace.sumNegative} = \\boxed{${trace.result}}$$
                            </div>
                        </div>
                    </div>
                `;
            } else if (trace.type === '2x2') {
                html += `
                    <div class="step">
                        <h4>üìê –î–µ—Ç–µ—Ä–º–∏–Ω–∞–Ω—Ç 2√ó2</h4>
                        <div class="formula-box">
                            <div class="math">$$\\det\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix} = ad - bc$$</div>
                        </div>
                        <div class="step-content">
                            <strong>–ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π:</strong>
                            a = ${trace.a}, b = ${trace.b}, c = ${trace.c}, d = ${trace.d}
                            
                            <strong>–í—ã—á–∏—Å–ª–µ–Ω–∏—è:</strong>
                            ad = ${trace.a} √ó ${trace.d} = ${trace.ad}
                            bc = ${trace.b} √ó ${trace.c} = ${trace.bc}
                            
                            <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong>
                            det = ad - bc = ${trace.ad} - ${trace.bc} = ${trace.result}
                        </div>
                    </div>
                `;
            } else if (trace.type === 'laplace') {
                const directionText = trace.direction === 'row' ? '—Å—Ç—Ä–æ–∫–µ' : '—Å—Ç–æ–ª–±—Ü—É';
                const directionSymbol = trace.direction === 'row' ? 'i' : 'j';
                const sumIndex = trace.direction === 'row' ? 'k' : 'k';
                const elementIndex = trace.direction === 'row' ? 'i,k' : 'k,j';
                const minorIndex = trace.direction === 'row' ? 'i,k' : 'k,j';
                
                html += `
                    <div class="step">
                        <h4>üîç –†–∞–∑–ª–æ–∂–µ–Ω–∏–µ –ø–æ ${directionText} ${trace.index + 1}</h4>
                        <div class="formula-box">
                            <div class="math">
                                $$\\det(A) = \\sum_{${sumIndex}=1}^{${trace.size}} (-1)^{${directionSymbol}+${sumIndex}} \\cdot a_{${elementIndex}} \\cdot M_{${minorIndex}}$$
                            </div>
                        </div>
                `;
                
                trace.terms.forEach((term, i) => {
                    const sign = term.sign > 0 ? '+' : '-';
                    const power = (trace.index + i) % 2 === 0 ? 'i+k' : 'i+k';
                    const signColor = term.sign > 0 ? '#27ae60' : '#e74c3c';
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–∏–Ω–æ—Ä
                    const minorStr = renderMinorMatrix(term.minor);
                    
                    html += `
                        <div class="trace-node">
                            <h5>üìä –°–ª–∞–≥–∞–µ–º–æ–µ ${i + 1}: $a_{${term.i},${term.j}} = ${term.element}$</h5>
                            <div class="formula-box">
                                <div class="math">
                                    $$\\text{–ó–Ω–∞–∫: } ${sign}(-1)^{${power}} = ${sign}$$<br>
                                    $$\\text{–≠–ª–µ–º–µ–Ω—Ç: } a_{${term.i},${term.j}} = ${term.element}$$<br>
                                    $$\\text{–ú–∏–Ω–æ—Ä: } M_{${term.i},${term.j}} = ${minorStr}$$<br>
                                    $$\\text{–ö–æ—Ñ–∞–∫—Ç–æ—Ä: } C_{${term.i},${term.j}} = ${term.cofactor}$$<br>
                                    $$\\text{–í–∫–ª–∞–¥: } ${term.termValue}$$
                                </div>
                            </div>
                            ${renderTrace(term.subTrace, depth + 1)}
                        </div>
                    `;
                });
                
                html += `
                        <div class="formula-box">
                            <div class="math">
                                $$\\text{–ò—Ç–æ–≥–æ: } \\boxed{${trace.result}}$$
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }

        function renderTraceText(trace, depth) {
            let text = '';
            const indent = '  '.repeat(depth);
            
            if (trace.type === 'sarrus') {
                text += `${indent}–ú–µ—Ç–æ–¥ –°–∞—Ä—Ä—é—Å–∞ (3√ó3)\n`;
                text += `${indent}${trace.formula}\n\n`;
                
                text += `${indent}–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–∞–≥–∞–µ–º—ã–µ:\n`;
                trace.positiveTerms.forEach((term, i) => {
                    text += `${indent}  ${i + 1}. ${term.formula} = ${term.values} = ${term.result}\n`;
                });
                
                text += `\n${indent}–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Å–ª–∞–≥–∞–µ–º—ã–µ:\n`;
                trace.negativeTerms.forEach((term, i) => {
                    text += `${indent}  ${i + 1}. ${term.formula} = ${term.values} = ${term.result}\n`;
                });
                
                text += `\n${indent}S‚Çä = ${trace.sumPositive}\n`;
                text += `${indent}S‚Çã = ${trace.sumNegative}\n`;
                text += `${indent}det = S‚Çä - S‚Çã = ${trace.result}\n\n`;
            } else if (trace.type === '2x2') {
                text += `${indent}–î–µ—Ç–µ—Ä–º–∏–Ω–∞–Ω—Ç 2√ó2\n`;
                text += `${indent}–§–æ—Ä–º—É–ª–∞: ${trace.formula}\n`;
                text += `${indent}a = ${trace.a}, b = ${trace.b}, c = ${trace.c}, d = ${trace.d}\n`;
                text += `${indent}ad = ${trace.a} √ó ${trace.d} = ${trace.ad}\n`;
                text += `${indent}bc = ${trace.b} √ó ${trace.c} = ${trace.bc}\n`;
                text += `${indent}det = ad - bc = ${trace.ad} - ${trace.bc} = ${trace.result}\n\n`;
            } else if (trace.type === 'laplace') {
                const directionText = trace.direction === 'row' ? '—Å—Ç—Ä–æ–∫–µ' : '—Å—Ç–æ–ª–±—Ü—É';
                text += `${indent}–†–∞–∑–ª–æ–∂–µ–Ω–∏–µ –ø–æ ${directionText} ${trace.index + 1}\n`;
                text += `${indent}–§–æ—Ä–º—É–ª–∞: det(A) = ‚àë‚Çñ (-1)^(i+k) √ó a_{i,k} √ó M_{i,k}\n\n`;
                
                trace.terms.forEach((term, i) => {
                    const sign = term.sign > 0 ? '+' : '-';
                    text += `${indent}  –°–ª–∞–≥–∞–µ–º–æ–µ ${i + 1}: a_{${term.i},${term.j}} = ${term.element}\n`;
                    text += `${indent}    –ó–Ω–∞–∫: ${sign}, –ö–æ—Ñ–∞–∫—Ç–æ—Ä: ${term.cofactor}, –í–∫–ª–∞–¥: ${term.termValue}\n`;
                    text += renderTraceText(term.subTrace, depth + 2);
                });
                
                text += `${indent}–ò—Ç–æ–≥–æ: ${trace.result}\n\n`;
            }
            
            return text;
        }

        function showError(message) {
            const solutionDiv = document.getElementById('solution');
            const contentDiv = document.getElementById('solutionContent');
            
            contentDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${message}</div>`;
            solutionDiv.style.display = 'block';
            document.getElementById('copyBtn').disabled = true;
        }

        function copySolution() {
            if (solutionText) {
                navigator.clipboard.writeText(solutionText).then(() => {
                    const btn = document.getElementById('copyBtn');
                    const originalText = btn.textContent;
                    const originalBg = btn.style.background;
                    
                    btn.innerHTML = 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                    btn.classList.add('success-animation');
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = originalBg;
                        btn.classList.remove('success-animation');
                    }, 2000);
                }).catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                    const btn = document.getElementById('copyBtn');
                    btn.textContent = '‚ùå –û—à–∏–±–∫–∞';
                    btn.style.background = '#e74c3c';
                    setTimeout(() => {
                        btn.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ';
                        btn.style.background = '';
                    }, 2000);
                });
            }
        }
    </script>
</body>
</html>
